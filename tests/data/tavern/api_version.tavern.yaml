---
test_name: Check version

strict:
  - json:on

stages:
  - name: version (json output)
    request:
      url: http://{daemon_host}:{daemon_port}/sabnzbd/api
      method: GET
      params:
        mode: version
        apikey: "{daemon_apikey}"
        output: json
    response:
      status_code: 200
      headers:
        content-type: !re_match "application/json"
        content-type: !re_search "charset=(UTF|utf)-8"
      json:
        version: "{daemon_version}"

  - name: version (text output)
    request:
      url: http://{daemon_host}:{daemon_port}/sabnzbd/api
      method: GET
      params:
        mode: version
        apikey: "{daemon_apikey}"
        output: text
    response:
      status_code: 200
      headers:
        content-type: !re_match "text/plain"
        content-type: !re_search "charset=(UTF|utf)-8"
      verify_response_with:
        function: tavern.testutils.helpers:validate_regex
        extra_kwargs:
          expression: "{daemon_version}"

  - name: version (xml output)
    request:
      url: http://{daemon_host}:{daemon_port}/sabnzbd/api
      method: GET
      params:
        mode: version
        apikey: "{daemon_apikey}"
        output: xml
    response:
      status_code: 200
      headers:
        content-type: !re_match "text/xml"
        content-type: !re_search "charset=(UTF|utf)-8"
      verify_response_with:
        function: tavern.testutils.helpers:validate_regex
        extra_kwargs:
          expression: '<\?xml version="1.0" encoding="UTF-8" \?>\r?\n?<version>{daemon_version}</version>'
